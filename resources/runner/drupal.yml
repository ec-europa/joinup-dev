# Basic Drupal settings and commands.

command:
  drupal:
    options:
      sites-subdir: default

drupal:
  root: web
  base_url: ${env.DRUPAL_BASE_URL}
  site:
    name: ${env.DRUPAL_SITE_NAME}
    mail: ${env.DRUPAL_SITE_MAIL}
    profile: ${env.DRUPAL_SITE_PROFILE}
    locale: en
    existing_config: true
    skip_permissions_setup: true
  account:
    name: ${env.DRUPAL_ACCOUNT_NAME}
    password: ${env.DRUPAL_ACCOUNT_PASSWORD}
  database:
    scheme: mysql
    host: ${env.DRUPAL_DATABASE_HOST}
    port: ${env.DRUPAL_DATABASE_PORT}
    name: ${env.DRUPAL_DATABASE_NAME}
    user: ${env.DRUPAL_DATABASE_USERNAME}
    password: ${env.DRUPAL_DATABASE_PASSWORD}
  settings:
    presets:
      install:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
      site-clone:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
        - Error logging
        - Mail catch
        - Redis
        - Custom queue services
      site-clean:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
        - Development
        - OpenEuropa Newsroom Newsletter
        - OpenEuropa Webtools Geocoding Cache
        - Error logging
        - Mail catch
        - Redis
        - Custom queue services
      behat:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
        - Development
        - OpenEuropa Newsroom Newsletter
        - OpenEuropa Webtools Geocoding Cache
        - Redis
        - Custom queue services
      error_page_test:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
        - Development
        - OpenEuropa Newsroom Newsletter
        - OpenEuropa Webtools Geocoding Cache
        - Redis
        - Pipe errors to a temporary file
        - Custom queue services
      phpunit:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Permissions
        - Development
        - OpenEuropa Newsroom Newsletter
        - OpenEuropa Webtools Geocoding Cache
        - Error logging
        - Custom queue services
      prod:
        - Main settings
        - Databases
        - Configuration
        - Search API
        - Matomo & OpenEuropa Webtools Analytics
        - Custom error handler
        - Redis
        - Custom queue services
    header: |
      <?php

      /**
       * @file
       * Drupal settings file.
       *
       * This file is automatically generated by `drupal:settings` task runner
       * command and should not be edited manually.
       *
       * The Drupal settings are documented in the `default.settings.php` file.
       *
       * @see web/sites/default/default.settings.php
       */

      /** @var string $app_root */
      /** @var string $site_path */
    footer: |
      // Load environment development override configuration, if available. Keep this
      // code block at the end of this file to take full effect.
      if (file_exists("$app_root/$site_path/settings.override.php")) {
        include "$app_root/$site_path/settings.override.php";
      }
    sections:
      Main settings: |
        $settings['hash_salt'] = getenv('DRUPAL_HASH_SALT');
        $settings['container_yamls'][] = "$app_root/$site_path/services.yml";
        $settings['file_scan_ignore_directories'] = [
          'node_modules',
          'bower_components',
          // In some circumstances, the Bootstrap Components Library (BCL) components,
          // from "OE Bootstrap Theme", located under the theme assets directory
          // `web/themes/contrib/oe_bootstrap_theme/assets/bcl`, are discovered and used
          // as Drupal Twig templates. But they shouldn't be used directly, they rather
          // should be called by a UI Pattern wrapper. For instance, the accordion should
          // use `web/themes/contrib/oe_bootstrap_theme/templates/patterns/accordion`
          // rather than `web/themes/contrib/oe_bootstrap_theme/assets/bcl/bcl-accordion`.
          // This is a known issue with "OE Bootstrap Theme", handled in OEL-522. Until a
          // fix will be available, in OEL-522, we exclude the `bcl` from file scanning,
          // as a temporary fix.
          // @see https://citnet.tech.ec.europa.eu/CITnet/jira/browse/OEL-522
          'bcl',
        ];
        $settings['entity_update_batch_size'] = 50;
        $settings['entity_update_backup'] = TRUE;

        // File system settings.
        $settings['file_private_path'] = getenv('DRUPAL_PRIVATE_FILE_SYSTEM');
        $settings['file_temp_path'] = getenv('DRUPAL_FILE_TEMP_PATH');
      Configuration: |
        $settings['config_exclude_modules'] = [
          'admin_toolbar',
          'admin_toolbar_tools',
          'cas_mock_server',
          'config_devel',
          'config_update',
          'config_update_ui',
          'dblog',
          'devel',
          'filecache',
          'joinup_cas_mock_server',
          'og_ui',
          'page_manager_ui',
          'stage_file_proxy',
          'views_ui',
        ];
        // Location of the site configuration files.
        $settings['config_sync_directory'] = '../config/sync';
        $settings['config_readonly'] = !file_exists(getcwd() . '/../disable-config-readonly');
      Databases: |
        $databases['default']['default'] = [
          'database' => getenv('DRUPAL_DATABASE_NAME'),
          'username' => getenv('DRUPAL_DATABASE_USERNAME'),
          'password' => getenv('DRUPAL_DATABASE_PASSWORD'),
          'host' => getenv('DRUPAL_DATABASE_HOST'),
          'port' => getenv('DRUPAL_DATABASE_PORT'),
          'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
          'driver' => 'mysql',
        ];
        $databases['sparql_default']['default'] = [
          'host' => getenv('SPARQL_HOST'),
          'port' => getenv('SPARQL_PORT'),
          'namespace' => 'Drupal\\joinup_sparql\\Driver\\Database\\joinup_sparql',
          'driver' => 'sparql',
        ];
        $settings['joinup']['sparql_public_endpoint'] = getenv('SPARQL_PUBLIC_ENDPOINT');
      Permissions: |
        $settings['skip_permissions_hardening'] = TRUE;
      Stage File Proxy: |
        $config['stage_file_proxy.settings'] = [
          'hotlink' => FALSE,
          'origin' => 'https://joinup.ec.europa.eu/',
          'origin_dir' => FALSE,
          'use_imagecache_root' => TRUE,
          'verify' => TRUE,
        ];
      Mail catch: |
        $config['system.mail']['interface']['default'] = 'devel_mail_log';
        $config['mailsystem.settings']['defaults']['sender'] = 'devel_mail_log';
      Search API: |
        $config['search_api.server.solr_published']['backend_config']['connector_config'] = parse_url(getenv('SOLR_CORE_PUBLISHED_URL'));
        $config['search_api.server.solr_published']['backend_config']['connector_config']['core'] = getenv('SOLR_CORE_PUBLISHED_NAME');
        $config['search_api.server.solr_unpublished']['backend_config']['connector_config'] = parse_url(getenv('SOLR_CORE_UNPUBLISHED_URL'));
        $config['search_api.server.solr_unpublished']['backend_config']['connector_config']['core'] = getenv('SOLR_CORE_UNPUBLISHED_NAME');;
      Matomo & OpenEuropa Webtools Analytics: |
        $config['matomo.settings']['site_id'] = getenv('MATOMO_SITE_ID');
        $config['matomo.settings']['url_http'] = getenv('MATOMO_SITE_URL_HTTP');
        $config['matomo.settings']['url_https'] = getenv('MATOMO_SITE_URL_HTTPS');
        $config['matomo_reporting_api.settings']['token_auth'] = getenv('MATOMO_REPORTING_API_AUTH_TOKEN');
        $config['oe_webtools_analytics.settings']['siteID'] = getenv('MATOMO_SITE_ID');
        $config['oe_webtools_analytics.settings']['sitePath'] = getenv('OE_WEBTOOLS_ANALYTICS_SITE_PATH');
        $config['oe_webtools_analytics.settings']['instance'] = getenv('OE_WEBTOOLS_ANALYTICS_SITE_INSTANCE');
      Redis: |
        $settings['redis.connection']['interface'] = getenv('REDIS_INTERFACE');
        $settings['redis.connection']['host'] = getenv('REDIS_HOST');
        $settings['redis.connection']['port'] = getenv('REDIS_PORT');
        $settings['cache']['default'] = 'cache.backend.redis';
        $settings['container_yamls'][] = DRUPAL_ROOT . '/modules/contrib/redis/example.services.yml';
      Custom error handler: |
        $settings['error_page']['uuid'] = TRUE;
        $settings['error_page']['template_dir'] = DRUPAL_ROOT . '/../resources/error_page';
        set_error_handler(['Drupal\error_page\ErrorPageErrorHandler', 'handleError']);
        set_exception_handler(['Drupal\error_page\ErrorPageErrorHandler', 'handleException']);
      Pipe errors to a temporary file: |
        $settings['error_page']['log']['method'] = 3;
        $settings['error_page']['log']['destination'] = 'php://temp';
      OpenEuropa Newsroom Newsletter: |
        $config['oe_newsroom_newsletter.subscriber']['class'] = 'Drupal\oe_newsroom_newsletter\NewsletterSubscriber\MockNewsletterSubscriber';
      OpenEuropa Webtools Geocoding Cache: |
        $settings['cache']['bins']['geocoder'] = 'cache.backend.file_system';
        $settings['filecache']['directory']['bins']['geocoder'] = '../tests/fixtures/webtools_geocoding_cache';
        $settings['filecache']['strategy']['bins']['geocoder'] = 'persist';
      Development: |
        $settings['extension_discovery_scan_tests'] = TRUE;
      Error logging: |
        $config['system.logging']['error_level'] = 'verbose';
      Custom queue services: |
        $settings['queue_service_joinup_group:group_update'] = 'joinup_group.group_aware_queue';
        $settings['queue_service_joinup_group:group_content_update'] = 'joinup_group.group_aware_queue';
