<?php

/**
 * @file
 * Contains \AssetDistributionSubContext.
 */

use Behat\Gherkin\Node\TableNode;
use Behat\Mink\Exception\ElementNotFoundException;
use Drupal\Component\Utility\UrlHelper;
use Drupal\DrupalExtension\Context\DrupalSubContextBase;
use Drupal\DrupalExtension\Context\DrupalSubContextInterface;
use Drupal\joinup\Traits\FileTrait;
use Drupal\joinup\Traits\RandomGeneratorTrait;
use Drupal\joinup\Traits\RdfEntityTrait;
use Drupal\og\OgGroupAudienceHelperInterface;
use Drupal\rdf_entity\Entity\Rdf;
use Drupal\rdf_file\RdfFileHandler;

/**
 * Behat step definitions for testing asset distributions.
 */
class AssetDistributionSubContext extends DrupalSubContextBase implements DrupalSubContextInterface {

  use FileTrait;
  use RandomGeneratorTrait;
  use RdfEntityTrait;

  /**
   * Test asset distributions.
   *
   * @var \Drupal\rdf_entity\Entity\Rdf[]
   */
  protected $assetDistributions = [];

  /**
   * Navigates to the canonical page display of an asset distribution.
   *
   * @param string $asset_distribution
   *   The title of the asset distribution.
   *
   * @When (I )go to (the homepage of )the :asset_distribution distribution
   * @When (I )visit (the homepage of )the :asset_distribution distribution
   */
  public function visitDistribution($asset_distribution) {
    /** @var \Drupal\rdf_entity\Entity\Rdf $asset_distribution */
    $asset_distribution = $this->getAssetDistributionByName($asset_distribution);
    $this->visitPath($asset_distribution->url());
  }

  /**
   * Navigates to the edit form of an asset distribution.
   *
   * @param string $asset_distribution
   *   The title of the $asset_distribution.
   *
   * @When (I )go to the :asset_distribution asset distribution edit form
   * @When (I )visit the :asset_distribution asset distribution edit form
   */
  public function visitEditAssetDistribution($asset_distribution) {
    /** @var \Drupal\rdf_entity\Entity\Rdf $asset_distribution */
    $asset_distribution = $this->getAssetDistributionByName($asset_distribution);
    $path = $asset_distribution->url('edit-form');
    $this->visitPath($path);
  }

  /**
   * Creates a number of asset distributions with data provided in a table.
   *
   * @param TableNode $asset_distribution_table
   *   The asset distribution data.
   *
   * @codingStandardsIgnoreStart
   *   Table format:
   *   | uri                                     | title            | description                | access url                               | creation date     | modification date | parent        |
   *   | http://joinup.eu/asset_distribution/foo | Foo distribution | This is a foo distribution | test.zip                                 | 28-01-1995 12:05  | 30-01-1995 10:44  | Solution name |
   *   | http://joinup.eu/asset_distribution/bar | Bar distribution | This is a bar distribution | http://external_url.com/path-to-file.zip | 28-01-1995 12:06  |                   | Release name  |
   * @codingStandardsIgnoreEnd
   *
   * Fields title and description are mandatory. Field 'access url' can be
   * either an external valid URL or a local file to be uploaded.
   *
   * @throws \Exception
   *   Thrown when a column name is incorrect.
   *
   * @Given (the following )(asset )distributions:
   */
  public function givenAssetDistributions(TableNode $asset_distribution_table) {
    foreach ($asset_distribution_table->getColumnsHash() as $values) {
      $this->createAssetDistributionFromAliasedTableValues($values);
    }
  }

  /**
   * Creates an asset distribution with data provided in a table.
   *
   * Table format:
   * | title       | Sample distribution                             |
   * | uri         | http://joinup.eu/distribution/foobar            |
   * | description | A sample distribution                           |
   * | access url  | http://external.path/to/file.zip  (or test.zip) |
   * | parent      | Release or solution name                        |
   *
   * Fields 'title' and 'description' are required. Field 'access url' can be
   * either an external valid URL or a local file to be uploaded.
   *
   * @param TableNode $asset_distribution_table
   *   The asset distribution data.
   *
   * @throws \Exception
   *   Thrown when a column name is incorrect.
   *
   * @Given (the following )(asset )distribution:
   */
  public function givenAssetDistribution(TableNode $asset_distribution_table) {
    $values = $asset_distribution_table->getRowsHash();
    $this->createAssetDistributionFromAliasedTableValues($values);
  }

  /**
   * Creates an asset distribution from the given property and field data.
   *
   * @param array $values
   *   An optional associative array of values, keyed by property name.
   *
   * @return \Drupal\rdf_entity\Entity\Rdf
   *   A new asset distribution entity.
   *
   * @throws \Exception
   *   Thrown when a given file is not found.
   */
  protected function createAssetDistribution(array $values) {
    // The Access URL field is either an external URI, or file upload.
    if (!empty($url = $values['field_ad_access_url'])) {
      global $base_url;
      if (!UrlHelper::isValid($url, TRUE) || !UrlHelper::isExternal($url) || UrlHelper::externalIsLocal($url, $base_url)) {
        // It's a local file to be uploaded.
        $values['field_ad_access_url'] = $this->uploadRdfFile($url, $this->getMinkParameter('files_path'));
      }
    }

    $values['rid'] = 'asset_distribution';
    $values['id'] = isset($values['id']) ? $values['id'] : $this->getRandomUri();
    $asset_distribution = Rdf::create($values);
    $asset_distribution->save();
    $this->assetDistributions[$asset_distribution->id()] = $asset_distribution;

    return $asset_distribution;
  }

  /**
   * Creates an asset distribution using the provided aliases table values.
   *
   * @param array $aliased_values
   *   An associative array of values used to create the distribuion, with keys
   *   using the aliases from self::assetDistributionFieldAliases(). If the key
   *   'parent' is present, a relation with a parent solution or release with
   *   a label matching this value will be created.
   *
   * @throws \Exception
   *   Thrown when an unknown key alias is present in the list of values.
   */
  protected function createAssetDistributionFromAliasedTableValues(array $aliased_values) {
    $aliases = self::assetDistributionFieldAliases();

    $values = [];
    // Replace the column aliases with the actual field names.
    foreach ($aliased_values as $key => $value) {
      if (array_key_exists($key, $aliases)) {
        $values[$aliases[$key]] = $value;
      }
      // If the 'parent' key is present we will have to create a relation to the
      // parent entity, which is either a release or a solution.
      elseif ($key === 'parent') {
        $parent_entity = self::getRdfEntityByLabel($value);

        // If we know the parent then we can transparently populate the group
        // reference to the solution.
        if (!array_key_exists('solution', $aliased_values)) {
          $solution_label = NULL;
          if ($parent_entity->bundle() === 'solution') {
            $solution_label = $parent_entity->label();
          }
          elseif ($solution_entity_id = $parent_entity->field_isr_is_version_of->value) {
            $solution_label = Rdf::load($solution_entity_id)->label();
          }
          $values[OgGroupAudienceHelperInterface::DEFAULT_FIELD] = $solution_label;
        }
      }
      else {
        throw new \Exception("Unknown key '$key' in asset distribution table.");
      }
    };

    $values = $this->convertValueAliases($values);

    $asset_distribution_entity = $this->createAssetDistribution($values);

    // Create the relation with the parent entity if requested.
    if (!empty($parent_entity)) {
      asset_distribution_add_parent_relation($asset_distribution_entity, $parent_entity);
    }
  }

  /**
   * Deletes an asset distribution.
   *
   * @param string $asset_distribution
   *   The title of the asset distribution.
   *
   * @When (I )delete the :asset_distribution asset distribution
   */
  public function deleteAssetDistribution($asset_distribution) {
    /** @var \Drupal\rdf_entity\Entity\Rdf $asset_distribution */
    $this->getAssetDistributionByName($asset_distribution)->delete();
  }

  /**
   * Returns the asset distribution with the given title.
   *
   * If multiple asset distributions have the same title,
   * the first one will be returned.
   *
   * @param string $title
   *   The asset distribution title.
   *
   * @return \Drupal\rdf_entity\Entity\Rdf
   *   The asset distribution.
   *
   * @throws \InvalidArgumentException
   *   Thrown when an asset distribution with the given title does not exist.
   */
  protected function getAssetDistributionByName($title) {
    return $this->getRdfEntityByLabel($title, 'asset_distribution');
  }

  /**
   * Returns the Solution with the given title.
   *
   * If multiple solution have the same title, the first one will be returned.
   *
   * @param string $title
   *   The solution title.
   *
   * @return \Drupal\rdf_entity\Entity\Rdf
   *   The solution.
   *
   * @throws \InvalidArgumentException
   *   Thrown when a solution with the given title does not exist.
   */
  protected function getSolutionByName($title) {
    return $this->getRdfEntityByLabel($title, 'solution');
  }

  /**
   * Checks the number of available asset distributions.
   *
   * @param int $number
   *   The expected number of asset distributions.
   *
   * @Then I should have :number distribution(s)
   */
  public function assertAssetDistributionCount($number) {
    $this->assertRdfEntityCount($number, 'asset_distribution');
  }

  /**
   * Navigates to the canonical page display of an asset distribution.
   *
   * @param string $title
   *   The title of the asset distribution.
   *
   * @When (I )go to (the homepage of )the :asset_distribution asset distribution
   * @When (I )visit (the homepage of )the :asset_distribution asset distribution
   */
  public function visitAssetDistribution($title) {
    $distribution = $this->getAssetDistributionByName($title);
    $this->visitPath($distribution->url());
  }

  /**
   * Remove any created asset distributions.
   *
   * @AfterScenario
   */
  public function cleanAssetDistributions() {
    // Remove any asset distributions that were created.
    foreach ($this->assetDistributions as $asset_distribution) {
      $asset_distribution->delete();
    }
  }

  /**
   * Field alias mapping.
   *
   * @return array
   *   Mapping.
   */
  protected static function assetDistributionFieldAliases() {
    // Mapping alias - field name.
    return [
      'uri' => 'id',
      'title' => 'label',
      'access url' => 'field_ad_access_url',
      'creation date' => 'field_ad_creation_date',
      'description' => 'field_ad_description',
      'file size' => 'field_ad_file_size',
      'format' => 'field_ad_format',
      'licence' => 'field_ad_licence',
      'modification date' => 'field_ad_modification_date',
      'representation technique' => 'field_ad_repr_technique',
      'solution' => OgGroupAudienceHelperInterface::DEFAULT_FIELD,
      'status' => 'field_status',
    ];
  }

  /**
   * Converts values from user friendly to normal machine values.
   *
   * @param array $fields
   *    An array of fields keyed by field name.
   *
   * @return array
   *    The array with the values converted.
   */
  protected function convertValueAliases(array $fields) {
    if (!empty($fields[OgGroupAudienceHelperInterface::DEFAULT_FIELD])) {
      $solution = $this->getRdfEntityByLabel($fields[OgGroupAudienceHelperInterface::DEFAULT_FIELD], 'solution');
      $fields[OgGroupAudienceHelperInterface::DEFAULT_FIELD] = $solution->id();
    }

    return $fields;
  }

  /**
   * Checks if a distribution in compact view contains download links.
   *
   * The compact view is used for example in the "Downloads" page.
   * This currently only checks the first download link.
   *
   * @param string $distribution
   *    The name of the distribution.
   *
   * @throws \Exception
   *   Thrown if the download link cannot be found.
   *
   * @Then I should see the download link in the :distribution( asset) distribution
   */
  public function assertLinkDistribution($distribution) {
    $distribution = $this->getAssetDistributionByName($distribution);
    if (empty($distribution->field_ad_access_url->first())) {
      throw new \Exception(sprintf('Asset distribution "%s" does not contain any download links.', $distribution->label()));
    }
    $file = RdfFileHandler::urlToFile($distribution->field_ad_access_url->target_id);
    $promoted_link = RdfFileHandler::isRemote($file) ? $distribution->field_ad_access_url->target_id : file_create_url($file->getFileUri());
    $result = $this->getSession()->getPage()->find('xpath', "//a[contains(., '{$distribution->label()}')]/ancestor::div[contains(concat(' ', @class, ' '), ' timeline__listing-item ')]//a[@href='{$promoted_link}']");
    if (empty($result)) {
      throw new \Exception(sprintf('No link was found in the "%s" distribution on the page %s', $distribution->label(), $this->getSession()->getCurrentUrl()));
    }
  }

  /**
   * Checks that a distribution in compact view does not contain download links.
   *
   * The compact view is used for example in the "Downloads" page.
   *
   * @param string $distribution
   *    The name of the distribution.
   *
   * @throws \Exception
   *   Thrown if the link was found.
   *
   * @Then the :distribution( asset) distribution should not have any download urls
   */
  public function assertNotLinkDistribution($distribution) {
    $link = $this->getSession()->getPage()->find('xpath', "//a[contains(text(), '$distribution')]/ancestor::div[contains(concat(' ', @class, ' '), ' timeline__listing-item ')]//span[contains(concat(' ', @class, ' '), ' file ')]/a");
    if (!empty($link)) {
      throw new \Exception(sprintf('Asset distribution "%s" contains download link(s).', $distribution));
    }
  }

  /**
   * Asserts that a file is attached to a distribution.
   *
   * @param string $distribution
   *    The distribution title.
   * @param string $file_name
   *    The file name.
   *
   * @throws \Exception
   *    Thrown when the file or the link is not found.
   *
   * @Then the :distribution distribution should have the link of the :file_name in the access URL field
   */
  public function assertLinkSynchronized($distribution, $file_name) {
    $distribution = $this->getAssetDistributionByName($distribution);
    $file = RdfFileHandler::urlToFile($distribution->field_ad_access_url->target_id);
    if (($file->getFilename() !== $file_name) || !file_create_url($file->getFileUri())) {
      throw new \Exception("The file {$file_name} was not found in the '{$distribution->label()}' distribution'");
    }

    $files_path = $this->getMinkParameter('files_path');
    $path = rtrim(realpath($files_path), DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR . $file_name;
    if (!is_file($path)) {
      throw new \Exception("File '$file_name' was not found in file path '$files_path'.");
    }

    /** @var \Symfony\Component\HttpFoundation\File\MimeType\MimeTypeGuesserInterface $mime_guesser */
    $mime_guesser = \Drupal::service('file.mime_type.guesser');
    $mime_type = $mime_guesser->guess($path);
    $expected_file_type = asset_distribution_get_file_type_term_by_mime($mime_type);
    $expected_file_size = filesize($path);

    // Test the file format.
    if ($expected_file_type !== $distribution->field_ad_format->target_id) {
      throw new \Exception("File '$file_name' has the format '{$distribution->field_ad_format->target_id}'. Expected '$expected_file_type'.");
    }

    // Test the file size.
    if ($expected_file_size !== (int) $distribution->field_ad_file_size->value) {
      throw new \Exception("File '$file_name' has the size '{$distribution->field_ad_file_size->value}'. Expected '$expected_file_size'.");
    }
  }

  /**
   * Upload a file to a 'rdf_file' field.
   *
   * @param string $filename
   *   The file name ti be uplaoded.
   * @param string $rdf_file_field
   *   The RDF field label.
   *
   * @throws \Exception
   *   The file to be uploaded doesn't exists.
   *
   * @Given I upload the file :filename to :rdf_file_field
   */
  public function uploadFileToRdfFileField($filename, $rdf_file_field) {
    $id = $this->rdfFileFieldHelper($rdf_file_field, 'file');

    // Qualify the file path.
    $files_path = $this->getMinkParameter('files_path');
    $path = rtrim(realpath($files_path), DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR . $filename;
    if (!is_file($path)) {
      throw new \Exception("File '$filename' was not found in file path '$files_path'.");
    }

    // Attach the file.
    $this->getSession()->getPage()->attachFileToField($id, $path);
  }

  /**
   * Sets an URI as remote file to a 'rdf_file' field.
   *
   * @param string $uri
   *   The URI string to be set.
   * @param string $rdf_file_field
   *   The RDF field label.
   *
   * @Given I set the URI :uri to :rdf_file_field
   */
  public function setUriToRdfFileField($uri, $rdf_file_field) {
    $id = $this->rdfFileFieldHelper($rdf_file_field, 'remote-file');
    // Fill in the text.
    $this->getSession()->getPage()->fillField($id, $uri);
  }

  /**
   * Provides a helper for RDF file field steps.
   *
   * @param string $rdf_file_field
   *   The RDF file field label.
   * @param string $option
   *   What option to use: 'file' or 'remote-file'.
   *
   * @return string
   *   The id attribute of the field being changed.
   *
   * @throws \Exception
   *   When parts of the widget cannot be found.
   */
  protected function rdfFileFieldHelper($rdf_file_field, $option) {
    $session = $this->getSession();
    $page = $session->getPage();

    // Locate the RDF file field widget wrapper.
    $wrapper = $page->find('xpath', "//label[text()='$rdf_file_field']/ancestor::div[contains(concat(' ', normalize-space(@class), ' '), ' field--type-rdf-file ')][1]");
    if (!$wrapper) {
      throw new ElementNotFoundException($session->getDriver(), "Cannot find RDF file field '$rdf_file_field'.");
    }
    // Get the data selector but trim the '-wrapper' suffix.
    $data_selector_base = substr($wrapper->getAttribute('data-drupal-selector'), 0, -8);

    // Select the option for file upload or remote file.
    $data_selector_radio = "$data_selector_base-0-file-wrap-select-$option";
    $radio = $page->find('xpath', "//input[@type='radio' and @data-drupal-selector='$data_selector_radio']");
    if (!$radio) {
      throw new \Exception($session->getDriver(), "Malformed RDF file field '$rdf_file_field': Can't find the inner '$option' radio option.");
    }
    $page->selectFieldOption($radio->getAttribute('name'), $option);

    // Find the field to be updated.
    if ($option === 'file') {
      $data_selector = "$data_selector_base-0-file-wrap-file-upload";
      $type = 'file';
    }
    else {
      $data_selector = "$data_selector_base-0-file-wrap-remote-file";
      $type = 'url';
    }
    $field = $page->find('xpath', "//input[@type='$type' and @data-drupal-selector='$data_selector']");
    if (!$field) {
      throw new \Exception($session->getDriver(), "Malformed RDF file field '$rdf_file_field': Can't find the inner field '$data_selector'.");
    }

    return $field->getAttribute('id');
  }

}
