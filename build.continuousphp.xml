<?xml version="1.0" encoding="UTF-8" ?>

<project name="ContinuousPHP" default="help">

    <target name="setup-continuousphp" depends="check-continuousphp">
        <exec command="./vendor/bin/run virtuoso:checkpoint-set -- -1" checkreturn="true" passthru="true"/>

        <echo message="Create Solr index" />
        <exec dir="${project.basedir}"
              command="sudo chmod -R 777 /opt/solr > /dev/null;
/opt/solr/bin/solr create_core -c drupal_published -d ${project.basedir}/web/modules/contrib/search_api_solr/solr-conf/6.x/;
/opt/solr/bin/solr create_core -c drupal_unpublished -d ${project.basedir}/web/modules/contrib/search_api_solr/solr-conf/6.x/"
              checkreturn="true"
              passthru="true" />
        <symlink link="${project.basedir}/vendor/bin/solr" target="/opt/solr/bin/solr"/>
    </target>

    <target name="check-continuousphp">
        <echo message="Check if we are running on ContinuousPHP" />
        <if>
            <not>
                <available file="/home/cphp" type="dir" property="environment.cphp" />
            </not>
            <then>
                <fail message="Only run this target on a ContinuousPHP test environment" />
            </then>
        </if>
    </target>

    <target name="build-continuousphp" depends="check-continuousphp">
        <echo message="Create the Behat configuration files to run in parallel." />
        <phingcall target="setup-behat">
            <property name="behat.yml.path" value="${behat.dir}/behat-only-selenium-cphp.yml" />
            <property name="behat.yml.template" value="${behat.dir}/behat-only-selenium-cphp.yml.dist" />
        </phingcall>
        <phingcall target="setup-behat">
            <property name="behat.yml.path" value="${behat.dir}/behat-group-a-cphp.yml" />
            <property name="behat.yml.template" value="${behat.dir}/behat-group-a-cphp.yml.dist" />
        </phingcall>
        <phingcall target="setup-behat">
            <property name="behat.yml.path" value="${behat.dir}/behat-group-b-cphp.yml" />
            <property name="behat.yml.template" value="${behat.dir}/behat-group-b-cphp.yml.dist" />
        </phingcall>
        <phingcall target="setup-behat">
            <property name="behat.yml.path" value="${behat.dir}/behat-remainder-cphp.yml" />
            <property name="behat.yml.template" value="${behat.dir}/behat-remainder-cphp.yml.dist" />
        </phingcall>

    </target>

    <!-- Checks to execute during build phase to exit early in case of easily preventable errors. -->
    <target name="sanity-check">
        <exec command="./vendor/bin/run dev:check-deprecated-code" checkreturn="true" passthru="true" />
    </target>

    <target name="create-phpunit-mysql-database">
        <php expression="explode('://', '${phpunit.db_url}', 2)[0]" returnProperty="phpunit.db.type"/>
        <if>
            <equals arg1="${phpunit.db.type}" arg2="mysql"/>
            <then>
                <drush
                        command="sql:create"
                        assume="yes"
                        root="${website.drupal.dir}"
                        bin="${drush.bin}"
                        verbose="${drush.verbose}">
                    <option name="db-url" value="${phpunit.db_url}"/>
                </drush>
            </then>
        </if>
    </target>

</project>
